function ShopAddgiftsBackendOrders(){var n=this;n.gifts=[],n.addGift=function(i){var d="?module=orders&action=getProduct&product_id="+i.product_id+"&order_id="+$.order_edit.id+"&currency="+$.order_edit.options.currency;$.getJSON(d,function(d){var t=$("#order-items"),e=parseInt(t.find(".s-order-item:last").attr("data-index"),10)+1||0,r=d.data.product;r.name=i.name,r.price=i.price,i.sku_id&&r.skus[i.sku_id]&&(r.skus[i.sku_id].checked=!0),$("#order-currency").length&&!$("#order-currency").attr("disabled")&&($('<input type="hidden" name="currency">').val($("#order-currency").val()).insertAfter($("#order-currency")),$("#order-currency").attr("disabled","disabled"));var s=$("#s-orders-add-row");s.before(tmpl("template-order",{data:d.data,options:{index:e,currency:$.order_edit.options.currency,stocks:$.order_edit.stocks,price_edit:1}}));var a=s.prev();a.addClass("js-addgifts__added").css("borderLeft","solid 3px green"),a.find(".s-orders-product-price input").val(i.price),a.find(".s-orders-quantity").val(i.quantity),$("#s-order-comment-edit").show()})},$(document).on("click",".js-addgifts__add_button",function(d){d.preventDefault();var t=$(this);for(var e in t.attr("disable","disabled"),$('[name*="product[add]"]').each(function(){$(this).closest(".s-order-item").addClass("js-addgifts__added")}),$(".js-addgifts__order_item").remove(),$(".js-addgifts__order_after").closest("tr").remove(),n.gifts)n.addGift(n.gifts[e]);t.hide()}),$(document).on("order_total_updated",function(){var e=[];if($('[name*="product[add]"]').each(function(){var d=$(this).closest(".s-order-item");if(!d.hasClass("js-addgifts__added")){var t={id:d.data("index"),product_id:d.data("product-id"),quantity:d.find(".s-orders-quantity").val(),price:d.find(".js-order-edit-item-price").val(),type:"product"};e.push(t)}}),e.length){var i=$(".js-addgifts__add_button");i.length||($('<span class="js-addgifts__check_gifts" style="display: none">проверяем подарки ... </span><button type="button" style="display: none;margin-right: 15px" class="js-addgifts__add_button button green">Добавить подарки</button>').insertBefore("#order-items .save .button"),i=$(".js-addgifts__add_button"));var o=$(".js-addgifts__check_gifts");o.show(),i.hide().attr("disabled","disabled"),$(".shop_addgifts--order-cart-item").addClass("shop_addgifts--loading"),$.post("?plugin=addgifts&action=orderedit",{items:e},function(d){if("none"!=d.data){for(var t in d.data.items){var e=d.data.items[t],r=$('.s-order-item[data-index="'+e.id+'"]'),s=r.find(".js-addgifts__order_item");s.length||(s=$("<div></div>").addClass("js-addgifts__order_item"),r.find("td").first().next().append(s)),s.html(e.html)}var a=$(".js-addgifts__order_after");a.length||($('<tr class="white"><td colspan="10"><div class="js-addgifts__order_after"</td></td></tr>').insertAfter($("#s-orders-add-row")),a=$(".js-addgifts__order_after")),a.html(d.data.after_items?d.data.after_items:""),d.data.have_gifts&&(i.show(),i.removeAttr("disabled")),n.gifts=d.data.gifts}else n.gifts=[];o.hide()})}})}var shop_addgifts__backend_orders=new ShopAddgiftsBackendOrders;